<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="kr.co.redbull.cart">


	<!-- 할인가격 -->
			<select id="sale" resultType="int">
				<![CDATA[
					SELECT NVL(SUM(p.bprice * p.discount * c.cartcnt),0) as save
					FROM cart c JOIN PRODUCT p
					ON c.pnum = p.pnum
					AND c.regid = #{regId, jdbcType=VARCHAR}
				]]>
			</select>
		
	<!--  배송비 -->
		<select id="delivery" resultType="int">
			<![CDATA[
				SELECT NVL(SUM(p.dprice),0) delivery
				FROM cart c JOIN PRODUCT p
				ON c.pnum = p.pnum
				AND c.regid = #{regId, jdbcType=VARCHAR}
			]]>
	</select>

	<!-- 총 상품 금액-->
	<select id="total" resultType="int">
		<![CDATA[
			SELECT NVL(SUM(p.bprice * c.cartcnt),0) as total
			FROM cart c JOIN PRODUCT p
			ON c.pnum = p.pnum
			AND c.regid = #{regId, jdbcType=VARCHAR}
		]]>
	</select>
	
 	 <!-- Cart 조회 -->
 	 <select id="get_cartList" parameterType="Cart" resultType="Cart">
		 	<![CDATA[
					SELECT 
						   i.save_file_nm as saveFileNm,
						   c.cartnum as cartNum,
						   p.bprice as bPrice,
						   p.pname as pName,
						   p.pnum as pNum,
					       p.dprice as dPrice,
					       p.bprice - (p.bprice * p.discount) as afterPrice,
					       c.cartcnt as cartCnt,
					       c.regid as regId
					FROM CART c JOIN PRODUCT p
					ON c.pnum = p.pnum
					JOIN IMAGE i
					ON c.pnum = i.refnum
					AND c.regid = #{regId, jdbcType=VARCHAR}
			]]>
 	 </select>

	<!-- cart 수량 수정 -->
	<update id="do_update" parameterType="Cart">
			<![CDATA[
				UPDATE CART
				
				SET cartcnt = #{cartCnt, jdbcType=NUMERIC} 
				
				WHERE pnum = #{pNum, jdbcType=NUMERIC}
			    AND	  regid = #{regId, jdbcType=VARCHAR}
		    ]]>
		      	  
	</update>
	
	<!-- 현재 cart 수량확인 -->
	<select id="countCart" resultType="int">
			<![CDATA[
				SELECT COUNT(*)
				FROM CART c, PRODUCT p
				WHERE c.pnum = p.pnum
				AND c.regid = #{regId, jdbcType=VARCHAR}
			]]>
	</select>
	
	<!-- 이미 상품이 존재할 경우 수량 증가 -->
	<update id="updateCart" parameterType="Cart">
		<![CDATA[
			UPDATE CART 
			SET cartcnt = cartcnt + #{cartCnt, jdbcType=NUMERIC}
			WHERE regid = #{regId, jdbcType=VARCHAR}
			AND pnum = #{pNum, jdbcType=NUMERIC}
		]]>
	</update>
	
	<!-- 상품이 없을경우 추가 -->
	<insert id="do_save" parameterType="Cart">
			INSERT INTO CART (
			    PNUM,
			    CARTCNT,
			    REGID
			) VALUES (
			    #{pNum, jdbcType=NUMERIC},
			    1,
			    #{regId, jdbcType=VARCHAR}
			)
	</insert>
	
	<!-- 상품 삭제 -->
	<delete id="do_delete" parameterType="Cart">
		<![CDATA[
			DELETE FROM CART
			WHERE regid = #{regId, jdbcType=VARCHAR}
		]]>
	</delete>

</mapper>