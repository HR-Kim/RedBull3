<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="kr.co.redbull.cart">

 	 <sql id="cartColumns">
               i.SAVE_FILE_NM as saveFileNm,
               c.CARTNUM as cartNum,
               p.BPRICE as bPrice,
               p.PNAME as pName,
               p.PNUM as pNum,
               p.DPRICE as dPrice,
               p.bprice - (p.bprice * p.discount) as afterPrice,
               c.CARTCNT as cartCnt,
               c.REGID as regId
 	 </sql>

 	 <sql id="baseCondition">
 	 		<choose>
 	 		 	<when test="'10' == searchDiv">
 	 				 and c.regid LIKE '%' || #{searchWord} || '%'
 	 			</when>
 	 			<otherwise></otherwise>
 	 		</choose>
 	 </sql>

	<!-- 할인가격 -->
			<select id="sale" resultType="int">
				<![CDATA[
					SELECT NVL(SUM(p.bprice * p.discount * c.cartcnt),0) as save
					FROM CART c JOIN PRODUCT p
					ON c.pnum = p.pnum
					AND c.regid = #{regId, jdbcType=VARCHAR}
				]]>
			</select>
		
	<!--  배송비 -->
		<select id="delivery" resultType="int">
			<![CDATA[
				SELECT NVL(SUM(p.dprice),0) delivery
				FROM CART c JOIN PRODUCT p
				ON c.pnum = p.pnum
				AND c.regid = #{regId, jdbcType=VARCHAR}
			]]>
	</select>

	<!-- 총 상품 금액-->
	<select id="total" resultType="int">
		<![CDATA[
			SELECT NVL(SUM(p.bprice * c.cartcnt),0) as total
			FROM cart c JOIN PRODUCT p
			ON c.pnum = p.pnum
			AND c.regid = #{regId, jdbcType=VARCHAR}
		]]>
	</select>
	
	 <!-- 단건조회 -->
 	 <select id="get_selectOne" parameterType="Cart" resultType="Cart">
	 	 	 SELECT	
	 	 	 	<include refid="cartColumns" />								
	         FROM CART c JOIN PRODUCT p
	         ON c.pNum = p.pNum
	         JOIN IMAGE i
	         ON c.pNum = i.refNum
			WHERE c.regid = #{regId, jdbcType=VARCHAR}
 	 </select>
 	 
 	 <!-- get_cartIdList -->
 	 <select id="get_cartIdList" parameterType="Search" resultType="Cart">
			SELECT
			        <include refid="cartColumns" />
			FROM
			        CART c JOIN PRODUCT p
			        ON c.pNum = p.pNum
			        JOIN IMAGE i
			        ON c.pNum = i.refNum
			WHERE c.regId LIKE '%' || #{searchWord} || '%'
			ORDER BY p.pNum ASC
 	 </select>
	
 	 <!-- Cart 조회 -->
 	 <select id="get_cartList" parameterType="Search" resultType="Cart">
		 	SELECT T1.*, T2.*
		    FROM
		    (
		        SELECT
		            B.rnum,
		            B.saveFileNm,
		            B.cartnum,
		            B.bprice as bPrice,
		            B.pname,
		            B.pnum,
		            B.dprice,
		            B.afterPrice,
		            B.cartcnt,
		            B.regid
		        FROM(
		            SELECT ROWNUM AS rnum, A.*
		            FROM(
		                 SELECT 
		                       i.save_file_nm as saveFileNm,
		                       c.cartnum as cartNum,
		                       p.bprice as bPrice,
		                       p.pname as pName,
		                       p.pnum as pNum,
		                       p.dprice as dPrice,
		                       p.bprice - (p.bprice * p.discount) as afterPrice,
		                       c.cartcnt as cartCnt,
		                       c.regid as regId
							FROM CART c JOIN PRODUCT p
							ON c.pnum = p.pnum
							JOIN IMAGE i
							ON c.pnum = i.refnum
							<!-- search condition -->
							<include refid="baseCondition" />
		                    )A
		            WHERE rownum <![CDATA[ <= ]]> (#{pageSize} * ( #{pageNum}-1)+ #{pageSize} ) 
		            )B
					WHERE B.rnum <![CDATA[ >= ]]> (#{pageSize} * (#{pageNum}-1)+1)
					)T1
		        CROSS JOIN(
						SELECT COUNT(*) total_cnt
						FROM CART c JOIN PRODUCT p
						ON c.pnum = p.pnum
						JOIN IMAGE i
						ON c.pnum = i.refnum
						<include refid="baseCondition" />
						)T2
 	 </select>

	<!-- cart 수량 수정 -->
	<update id="do_update" parameterType="Cart">
			<![CDATA[
				UPDATE CART
				
				SET cartcnt = #{cartCnt, jdbcType=NUMERIC} 
				
				WHERE pnum = #{pNum, jdbcType=NUMERIC}
			    AND	  regid = #{regId, jdbcType=VARCHAR}
		    ]]>
		      	  
	</update>
	
	<!-- 현재 cart 수량확인 -->
	<select id="countCart" resultType="int">
			<![CDATA[
				SELECT COUNT(*)
				FROM CART c, PRODUCT p
				WHERE c.pnum = p.pnum
				AND c.regid = #{regId, jdbcType=VARCHAR}
			]]>
	</select>
	
	<!-- 이미 상품이 존재할 경우 수량 증가 -->
	<update id="updateCart" parameterType="Cart">
		<![CDATA[
			UPDATE CART 
			SET cartcnt = cartcnt + #{cartCnt, jdbcType=NUMERIC}
			WHERE regid = #{regId, jdbcType=VARCHAR}
			AND pnum = #{pNum, jdbcType=NUMERIC}
		]]>
	</update>
	
	<!-- 상품이 없을경우 추가 -->
	<insert id="do_save" parameterType="Cart">
			INSERT INTO CART (
			    PNUM,
			    CARTCNT,
			    REGID
			) VALUES (
			    #{pNum, jdbcType=NUMERIC},
			    1,
			    #{regId, jdbcType=VARCHAR}
			)
	</insert>
	
	<!-- 상품 삭제 -->
	<delete id="do_delete" parameterType="Cart">
		<![CDATA[
			DELETE FROM CART
			WHERE regid = #{regId, jdbcType=VARCHAR}
		]]>
	</delete>

</mapper>